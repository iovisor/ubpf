#
# Copyright (c) 2022-present, IO Visor Project
# All rights reserved.
#
# This source code is licensed in accordance with the terms specified in
# the LICENSE file found in the root directory of this source tree.
#

name: Windows

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string

      build_type:
        required: true
        type: string

      upload_packages:
        required: false
        type: boolean
        default: false

      build_codeql:
        required: false
        type: boolean
        default: false

      disable_retpolines:
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  build:
    permissions:
      actions: read  # for github/codeql-action/init to get workflow details
      contents: read  # for actions/checkout to fetch code
      security-events: write  # for github/codeql-action/analyze to upload SARIF results
    runs-on: ${{ inputs.platform }}

    steps:
    - name: Harden Runner
      uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        submodules: 'recursive'

    - name: Initialize CodeQL
      if: inputs.build_codeql == true
      uses: github/codeql-action/init@9e907b5e64f6b83e7804b09294d44122997950d6
      with:
        languages: 'cpp'

    - name: Cache the build folder
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306
      env:
        cache-name: cache-nuget-modules
      with:
        path: build
        key: ${{ matrix.platform }}-${{ matrix.arch }}-${{ hashFiles('**/CMakeLists.txt') }}-${{ hashFiles('.github/workflows/windows.yml') }}

    - name: Configure uBPF
      run: |
        cmake `
          -S . `
          -B build `
          -DUBPF_ENABLE_TESTS=true `
          -DUBPF_DISABLE_RETPOLINES=${{ inputs.disable_retpolines }} `
          -DUBPF_ENABLE_INSTALL=true

    - name: Build uBPF
      run: |
        cmake `
          --build build `
          --config ${{ inputs.build_type }}

    - name: Run the CTest suite
      working-directory: build
      run: |
        ctest --output-on-failure --build-config ${{ inputs.build_type }}
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Run tests with constant blinding enabled
      working-directory: ${{github.workspace}}/build
      env:
        UBPF_ENABLE_CONSTANT_BLINDING: 1
      run: |
        # Run JIT tests with constant blinding enabled to verify compatibility
        # Tests end with "-JIT" (e.g., "add.data-JIT", "mov64-imm.data-JIT")
        ctest -R "\-JIT$" --output-on-failure --build-config ${{ inputs.build_type }}

    - name: Run tests with constant blinding enabled
      working-directory: ${{github.workspace}}/build
      env:
        UBPF_ENABLE_CONSTANT_BLINDING: 1
      run: |
        # Run JIT tests with constant blinding enabled to verify compatibility
        # Tests end with "-JIT" (e.g., "add.data-JIT", "mov64-imm.data-JIT")
        ctest -R "\-JIT$" --output-on-failure --build-config ${{ inputs.build_type }}

    - name: Rerun failed tests with more verbose output
      if: failure()
      working-directory: ${{github.workspace}}/build
      run: |
        ctest --rerun-failed --output-on-failure --build-config ${{ inputs.build_type }}
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Generate the TGZ package
      run: |
        cmake `
          -S . `
          -B build `
          -DUBPF_ENABLE_PACKAGE=true `
          -DCPACK_GENERATOR=TGZ

        cmake `
          --build build `
          --target package

    - name: Locate the packages
      id: package_locations
      if: inputs.upload_packages == true
      shell: bash
      run: |
        echo "REL_TGZ_PACKAGE_PATH=$(ls build/*.tar.gz)" >> $GITHUB_OUTPUT

    - name: Upload the Windows TGZ package
      if: inputs.upload_packages == true
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: windows_tgz_package
        path: ${{ steps.package_locations.outputs.REL_TGZ_PACKAGE_PATH }}
        retention-days: 5

    - name: Perform CodeQL Analysis
      if: inputs.build_codeql == true
      uses: github/codeql-action/analyze@9e907b5e64f6b83e7804b09294d44122997950d6
